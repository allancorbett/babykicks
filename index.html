<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#b35a7a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.json">
  <title>Baby Kick Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fef7f0;
      color: #3d2c2c;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
      color: #b35a7a;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #999;
      margin-bottom: 24px;
    }

    #kick-btn {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #f7a8c4, #b35a7a);
      color: #fff;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 24px rgba(179, 90, 122, 0.35);
      transition: transform 0.1s, box-shadow 0.1s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #kick-btn:active {
      transform: scale(0.93);
      box-shadow: 0 2px 10px rgba(179, 90, 122, 0.3);
    }

    #kick-btn.flash {
      animation: pop 0.3s ease;
    }

    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    .stats {
      display: flex;
      gap: 24px;
      margin: 20px 0;
      font-size: 0.95rem;
    }

    .stats span {
      background: #fff;
      padding: 8px 16px;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .stats strong { color: #b35a7a; }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 24px 0 8px;
      color: #b35a7a;
      width: 100%;
      max-width: 500px;
    }

    /* Chart */
    .chart-container {
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      margin-bottom: 8px;
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    /* Kick log */
    .log-container {
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      margin-bottom: 16px;
      max-height: 340px;
      overflow-y: auto;
    }

    .day-group { margin-bottom: 14px; }

    .day-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: #b35a7a;
      margin-bottom: 4px;
      position: sticky;
      top: 0;
      background: #fff;
      padding: 2px 0;
    }

    .kick-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      font-size: 0.85rem;
      border-bottom: 1px solid #f5eeee;
    }

    .kick-entry:last-child { border-bottom: none; }

    .kick-time { color: #555; }

    .delete-btn {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1rem;
      padding: 0 4px;
      line-height: 1;
    }

    .delete-btn:hover { color: #e55; }

    /* Actions */
    .actions {
      display: flex;
      gap: 10px;
      margin: 8px 0 16px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .actions button {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      color: #555;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .actions button:hover { background: #fef0f5; border-color: #b35a7a; color: #b35a7a; }

    /* Past kick modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 10;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      text-align: center;
      overflow: hidden;
    }

    .modal h2 {
      font-size: 1.1rem;
      color: #b35a7a;
      margin-bottom: 16px;
    }

    .modal label {
      display: block;
      text-align: left;
      font-size: 0.8rem;
      color: #777;
      margin: 10px 0 4px;
    }

    .modal input[type="date"],
    .modal input[type="time"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      color: #3d2c2c;
      -webkit-appearance: none;
      appearance: none;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }

    .modal-actions button {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .modal-actions .save-btn {
      background: linear-gradient(135deg, #f7a8c4, #b35a7a);
      color: #fff;
      border: none;
      font-weight: 600;
    }

    .modal-actions .cancel-btn {
      background: #fff;
      color: #555;
    }

    .empty-msg {
      text-align: center;
      color: #bbb;
      font-size: 0.85rem;
      padding: 20px 0;
    }

    footer {
      margin-top: 24px;
      padding: 16px;
      text-align: center;
      font-size: 0.75rem;
      color: #bbb;
      max-width: 500px;
      line-height: 1.5;
    }

    footer a {
      color: #b35a7a;
      text-decoration: none;
    }

    footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Baby Kicks</h1>
  <p class="subtitle">Tap the button each time you feel a kick</p>

  <button id="kick-btn">Record Kick</button>

  <div class="stats">
    <span>Today: <strong id="today-count">0</strong></span>
    <span>Total: <strong id="total-count">0</strong></span>
  </div>

  <div class="actions">
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="document.getElementById('import-file').click()">Import CSV</button>
    <input type="file" id="import-file" accept=".csv" style="display:none" onchange="importCSV(event)">
    <button onclick="openPastKick()">Add Past Kick</button>
    <button onclick="clearAll()">Clear All</button>
  </div>

  <div class="modal-overlay" id="past-modal">
    <div class="modal">
      <h2>Add Past Kick</h2>
      <label for="past-date">Date</label>
      <input type="date" id="past-date">
      <label for="past-time">Time</label>
      <input type="time" id="past-time" step="1">
      <div class="modal-actions">
        <button class="cancel-btn" onclick="closePastKick()">Cancel</button>
        <button class="save-btn" onclick="savePastKick()">Save</button>
      </div>
    </div>
  </div>

  <div class="section-title">Kick Pattern (last 14 days)</div>
  <div class="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <div class="section-title">Kick Log</div>
  <div class="log-container" id="log"></div>

  <footer>
    No data leaves your device. All kicks are stored locally in your browser.
    No analytics, no cookies, no tracking.
    <br><a href="https://github.com/allancorbett/babykicks">View on GitHub</a>
  </footer>

  <script>
    const STORAGE_KEY = 'babykicks';

    function getKicks() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveKicks(kicks) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(kicks));
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatTime(iso) {
      return new Date(iso).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function dateKey(iso) {
      const d = new Date(iso);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function todayKey() {
      return dateKey(new Date().toISOString());
    }

    // Record kick
    const btn = document.getElementById('kick-btn');
    btn.addEventListener('click', () => {
      const kicks = getKicks();
      kicks.push(new Date().toISOString());
      saveKicks(kicks);
      btn.classList.remove('flash');
      void btn.offsetWidth;
      btn.classList.add('flash');
      render();
    });

    // Delete a kick
    function deleteKick(index) {
      const kicks = getKicks();
      kicks.splice(index, 1);
      saveKicks(kicks);
      render();
    }

    // Export CSV
    function exportCSV() {
      const kicks = getKicks();
      if (!kicks.length) return;
      const rows = ['date,time,iso'];
      kicks.forEach(iso => {
        rows.push(`${dateKey(iso)},${formatTime(iso)},${iso}`);
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `babykicks-${todayKey()}.csv`;
      a.click();
    }

    // Import CSV
    function importCSV(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const lines = ev.target.result.split('\n').slice(1);
        const kicks = getKicks();
        let added = 0;
        const existing = new Set(kicks);
        lines.forEach(line => {
          const parts = line.split(',');
          const iso = (parts[2] || '').trim();
          if (iso && !existing.has(iso)) {
            kicks.push(iso);
            existing.add(iso);
            added++;
          }
        });
        kicks.sort();
        saveKicks(kicks);
        render();
        alert(`Imported ${added} new kick(s).`);
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // Clear all
    function clearAll() {
      if (confirm('Delete all recorded kicks?\n\nTip: You may want to export a CSV backup first.')) {
        saveKicks([]);
        render();
      }
    }

    // Render everything
    function render() {
      const kicks = getKicks();

      // Stats
      const today = todayKey();
      const todayCount = kicks.filter(k => dateKey(k) === today).length;
      document.getElementById('today-count').textContent = todayCount;
      document.getElementById('total-count').textContent = kicks.length;

      // Log grouped by day (newest first)
      const log = document.getElementById('log');
      if (!kicks.length) {
        log.innerHTML = '<div class="empty-msg">No kicks recorded yet</div>';
      } else {
        const grouped = {};
        kicks.forEach((iso, i) => {
          const dk = dateKey(iso);
          if (!grouped[dk]) grouped[dk] = [];
          grouped[dk].push({ iso, index: i });
        });

        const days = Object.keys(grouped).sort().reverse();
        let html = '';
        days.forEach(day => {
          const entries = grouped[day].sort((a, b) => b.iso.localeCompare(a.iso));
          html += `<div class="day-group"><div class="day-label">${formatDate(entries[0].iso)} (${entries.length})</div>`;
          entries.forEach(e => {
            html += `<div class="kick-entry"><span class="kick-time">${formatTime(e.iso)}</span><button class="delete-btn" onclick="deleteKick(${e.index})" title="Delete">&times;</button></div>`;
          });
          html += '</div>';
        });
        log.innerHTML = html;
      }

      drawChart(kicks);
    }

    // Scatter plot: X = date, Y = time of day
    function drawChart(kicks) {
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      const W = rect.width;
      const H = rect.height;

      ctx.clearRect(0, 0, W, H);

      if (!kicks.length) {
        ctx.fillStyle = '#ccc';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No data yet', W / 2, H / 2);
        return;
      }

      const padLeft = 38;
      const padRight = 12;
      const padTop = 12;
      const padBottom = 30;
      const chartW = W - padLeft - padRight;
      const chartH = H - padTop - padBottom;

      // Build 14-day range
      const dayKeys = [];
      const dayLabels = [];
      for (let i = 13; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dayKeys.push(dateKey(d.toISOString()));
        dayLabels.push(`${d.getMonth()+1}/${d.getDate()}`);
      }

      // Filter kicks to last 14 days & compute positions
      const daySet = new Set(dayKeys);
      const points = [];
      kicks.forEach(iso => {
        const dk = dateKey(iso);
        if (!daySet.has(dk)) return;
        const d = new Date(iso);
        const dayIdx = dayKeys.indexOf(dk);
        const minuteOfDay = d.getHours() * 60 + d.getMinutes();
        points.push({ dayIdx, minuteOfDay });
      });

      // Y-axis: hours 0â€“24 (top=0:00, bottom=24:00)
      const timeToY = (min) => padTop + (min / 1440) * chartH;
      const dayToX = (idx) => padLeft + (idx + 0.5) / dayKeys.length * chartW;

      // Horizontal grid lines (every 4 hours)
      ctx.strokeStyle = '#f0e8e8';
      ctx.lineWidth = 1;
      for (let h = 0; h <= 24; h += 4) {
        const y = timeToY(h * 60);
        ctx.beginPath();
        ctx.moveTo(padLeft, y);
        ctx.lineTo(W - padRight, y);
        ctx.stroke();

        ctx.fillStyle = '#bbb';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        const label = h === 24 ? '0:00' : `${h}:00`;
        ctx.fillText(label, padLeft - 4, y + 3);
      }

      // Vertical grid lines per day
      ctx.strokeStyle = '#f5eeee';
      dayKeys.forEach((_, i) => {
        const x = dayToX(i);
        ctx.beginPath();
        ctx.moveTo(x, padTop);
        ctx.lineTo(x, padTop + chartH);
        ctx.stroke();
      });

      // X-axis day labels
      ctx.fillStyle = '#999';
      ctx.font = '9px sans-serif';
      ctx.textAlign = 'center';
      dayKeys.forEach((_, i) => {
        ctx.fillText(dayLabels[i], dayToX(i), H - 6);
      });

      // Draw dots
      points.forEach(p => {
        const x = dayToX(p.dayIdx);
        const y = timeToY(p.minuteOfDay);
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(179, 90, 122, 0.7)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(179, 90, 122, 0.3)';
        ctx.lineWidth = 1;
        ctx.stroke();
      });
    }

    // Past kick modal
    function openPastKick() {
      const now = new Date();
      document.getElementById('past-date').value = dateKey(now.toISOString());
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('past-time').value = `${hh}:${mm}`;
      document.getElementById('past-modal').classList.add('open');
    }

    function closePastKick() {
      document.getElementById('past-modal').classList.remove('open');
    }

    function savePastKick() {
      const d = document.getElementById('past-date').value;
      const t = document.getElementById('past-time').value;
      if (!d || !t) { alert('Please fill in both date and time.'); return; }
      const iso = new Date(`${d}T${t}`).toISOString();
      const kicks = getKicks();
      kicks.push(iso);
      kicks.sort();
      saveKicks(kicks);
      closePastKick();
      render();
    }

    // Close modal on overlay click
    document.getElementById('past-modal').addEventListener('click', function(e) {
      if (e.target === this) closePastKick();
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }

    // Init
    render();
    window.addEventListener('resize', () => render());
  </script>
</body>
</html>
